---
title: "【GCP】CloudSQLとGAEでGoアプリをデプロイしちゃうぞ"
emoji: "🐁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Go", "GCP"]
published: false
---

# はじめに

Go で簡単なアプリを作ったので、GoogleAppEngine(以下「GAE」）のフレキシブル環境でデプロイして見たので、ハンズオン風自分用のメモとして残します。
GAE はスタンダード環境だと超簡単にデプロイできますが、ランタイムのバージョンが限られているところがネックです。
例えば Go は執筆時点では`1.19`が最新バージョンですが、GAE のスタンダード環境だと`1.16`までとまあまあ古いランタイムしか使えません。

# リポジトリ

参考までに今回作業していたリポジトリは以下です。

https://github.com/chillout2san/chi_authentication

# 前準備

- Google アカウントの作成は省略します。

- 以下ドキュメントを参考に GCP にログインしましょう。執筆時点では有効期限 90 日で 300 ドル分クレジットがもらえます。

https://cloud.google.com/docs/get-started?hl=ja

- コンソールに移動したら、`My First Project`というサンプルのプロジェクトにいるはずです。そのままでも良いですし、新しくプロジェクト作成してもらっても OK です。

# GCP の sdk をインストールする

- 以下ドキュメントを参考に sdk をインストールします。
- 各 OS ごとに用意されているフォルダをダウンロードして、解凍したものを配置したディレクトリでインストールのシェルスクリプトを叩くと、配置したディレクトリで`gcloud`コマンドのパスが通ります。ダウンロードフォルダとかでパス通るとめんどくさいので、ドキュメントにも記載がありますがホームディレクトリにファイルを解凍してからスクリプト叩くと良いでしょう。

https://cloud.google.com/sdk/docs/install?hl=ja

- インストール終わったら、以下コマンドを叩きましょう。バージョン情報が出てきたら OK です。出ない人はターミナルを再起動してみてください。

```bash
$ gcloud version
```

# CloudSQL の準備をする

- データベース使わない人はスキップ可です。

- 重要なところだけ抜粋します。なおデータベースエンジンは MySQL を選択しました。

- インスタンス ID とパスワードを設定します。インスタンス ID は分かりやすいものであれば何でも OK です。パスワードはこのデータベースに root ユーザーでアクセスするものになるので控えておきましょう。右にある`生成`を押すと安全なパスワードを生成できます。今回 MySQL のバージョンは`8.0`を選択しました。

![image.png](/images/c7b1bd4feb8800/instance_infomation.png)

- 構成の選択を行います。本番環境用のマッチョな構成か、開発環境用のコスパ高い構成かを選べます。今回は開発用なので`development`を選択しました。画面にも説明がありますが、構成の選択と言ってもオススメの設定をとりあえず GCP が設定してくれるだけで、後ほど各項目をカスタマイズできます。なのであんまり深く考えるところではないですね。

![image.png](/images/c7b1bd4feb8800/start_composition.png)

- リージョンとゾーンを選択します。今回は東京にしました。開発用なので高可用性にするかどうかはノーで大丈夫です。詳しく知りたい方は以下ドキュメントを参考にしてください。

![image.png](/images/c7b1bd4feb8800/region_and_zone.png)

https://cloud.google.com/solutions/cloud-sql-mysql-disaster-recovery-complete-failover-fallback?hl=ja

- マシンタイプを選択します。共有コアが一番安くなりますが、メモリが 1GB 切ってるのが何か嫌なので`軽量`を選択しました。

![image.png](/images/c7b1bd4feb8800/machine_type.png)

- ストレージの設定を行います。`SSD`、`10GB`、自動増量はオフにしました。`暗号化`のところはあんまり分かってません・・・。

![image.png](/images/c7b1bd4feb8800/storage.png)

- 接続の設定を行います。同じ GCP のサービスである GAE からは特段の設定なしにアクセスできました。おそらくデフォルトで認可済みネットワークに入っているっぽいですね。

![image.png](/images/c7b1bd4feb8800/connection.png)

- データの保護の箇所です。実験用なので全てオフにします。

![image.png](/images/c7b1bd4feb8800/data_defence.png)

- メンテナンスの設定です。本番環境だと、例えば日中によく使われるシステム(例えば営業ツールとか)だからメンテナンスは夜に実行されるように、みたいな調整をするようです。

![image.png](/images/c7b1bd4feb8800/maintenance.png)

- フラグとラベルは設定不要です。インスタンスを生成をクリックしてください。5 分程度時間かかりますが、インスタンス生成完了まで待ちましょう。完了したらインスタンス名をクリックします。

![image.png](/images/c7b1bd4feb8800/instance_list.png)

- 接続名も後ほど使いますので控えておいてください。終わったら`CLOUD SHELLで開く`を押下してください。

![image.png](/images/c7b1bd4feb8800/instance_info.png)

# Dockerfile を準備する

- 超シンプルな Dockerfile を用意します。コンテナへの接続うんぬんは GAE がやってくれるようです。楽ですね。

```Dockerfile
FROM golang:1.19-alpine

WORKDIR /app

COPY . .

RUN go mod tidy

RUN go build ./cmd/main.go

CMD ["./main"]
```

# CloudSQL と Go アプリケーションを接続する

- 以下記事を参考に、CloudSQL と Go のアプリケーションを接続します。TCP ソケット経由、Unix ソケット経由、CloudSQL コネクタの 3 パターン方法があり、今回は CloudSQL コネクターで接続しました。

https://cloud.google.com/sql/docs/mysql/connect-app-engine-flexible?hl=ja#connect_to

```go
var Db *sql.DB

func init() {
    // 今更タイポ見つけたけど、見なかったことにする。
    e := config.Enviroment

    d, err := cloudsqlconn.NewDialer(context.Background())
    if err != nil {
        log.Println("CloudSQLConn NewDaialer failed:", err)
    }
    mysql.RegisterDialContext("cloudsqlconn",
        func(ctx context.Context, addr string) (net.Conn, error) {
            // DbHostはCloudSQL作成時の「接続名」のところ。
            // {project名}:{リージョン}:{インスタンスのid}の形になっているはず。
            return d.Dial(ctx, e.DbHost)
        })

    dsn := fmt.Sprintf("%s:%s@cloudsqlconn(localhost:3306)/%s?parseTime=true",
        // DbUserはroot、DbPassは設定したパスワード。
        // DbNameはCloudShellでMySQLインスタンスの中に入ってデータベースを作成する。
        e.DbUser, e.DbPass, e.DbName)

    db, err := sql.Open("mysql", dsn)

    if err != nil {
        log.Println("Database connection failed:", err)
        return
    }

    Db = db
    // 実は接続自体が成功しているわけではないのだが、まあヨシとする。
    log.Println("Database connection success")
}
```

https://github.com/chillout2san/chi_authentication/blob/main/infrastructure/database.go

# app.yaml を準備する

# GCP の json を持ってくる

# デプロイしてみましょう

確認するべきはアカウントとプロジェクト
スクリプトにまとめてあるけど、大事なのは gcloud app deploy ですよ。

# 余談でござヰマス

- 普段業務ではインフラ周りを触らないので楽しかった。趣味レベルで AWS も触ったことあるけど、GCP の方がドキュメント読みやすくていいなと思った。

- GAE は環境変数を app.yaml 内に持たせるので、ローカルでアプリケーション実行する際には別途 env ファイルを用意しないと行けなさそう。それか app.yaml には持たせずに env ファイルに全部書いちゃって、Dockerfile でその env ファイル読み込めば行けるのかしら？

- 本記事執筆前に GAE フレキシブルかつ Docker 使った記事を探したが案外なかった。何でだろうと考えてたけど、それなら CloudRun 使うわっていう話なのかも？次は CloudRun 試してみたい。それ終わったら Terraform で IaC やってみたいなあ。
