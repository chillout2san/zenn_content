---
title: "【GCP】CloudSQLとGAEでGoアプリをデプロイしちゃうぞ"
emoji: "🐁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Go", "GCP"]
published: false
---

# はじめに

Go で簡単なアプリを作ったので、GoogleAppEngine(以下「GAE」）でデプロイしてみました。
GAE はスタンダード環境だと超簡単にデプロイできますが、ランタイムのバージョンが限られているところがネックです。
例えば Go は執筆時点では`1.19`が最新バージョンですが、GAE のスタンダード環境だと`1.16`までとまあまあ古いランタイムしか使えません。なんでやねん。
今回は GAE のフレキシブル環境かつ Docker のやってみた系の記事が少なかったこともあり、ハンズオン風自分用のメモとして残します。

# リポジトリ

参考までに今回作業していたリポジトリは以下です。

https://github.com/chillout2san/chi_authentication

# 前準備

- Google アカウントの作成は省略します。

- 以下ドキュメントを参考に GCP にログインしましょう。執筆時点では有効期限 90 日で 300 ドル分クレジットがもらえます。勉強目的であれば使い切ることはあまりないと思います。

https://cloud.google.com/docs/get-started?hl=ja

- コンソールに移動したら、`My First Project`というサンプルのプロジェクトにいるはずです。勉強用ならそのままでも良いですが、画面左上のプロジェクト名横の三角ボタンを押して、適当にプロジェクトを作っちゃいます。名前は何でも OK です。

# GCP の sdk をインストールする

- 以下ドキュメントを参考に sdk をインストールしましょう。
- 各 OS ごとに用意されているファイルをダウンロードして解凍したものを配置したディレクトリでインストールのシェルスクリプトを叩くと、配置したディレクトリで`gcloud`コマンドのパスが通ります。ダウンロードフォルダとかでパス通るとめんどくさいので、ドキュメントにも記載がありますがホームディレクトリにファイルを解凍してからスクリプト叩くと良さげです。

https://cloud.google.com/sdk/docs/install?hl=ja

- インストール終わったら、シェルの設定ファイルを再読み込みするなり、ターミナルを再起動したりするなりした後に以下コマンドを叩きましょう。バージョン情報が出てきたら OK です。

```bash
$ gcloud version
```

# CloudSQL の準備をする

- データベース使わない人はスキップしてもらっても良いです。

- コンソールから`SQL`を選択します。

![image.png](/images/c7b1bd4feb8800/7e5dbf2d-16c7-356d-46dc-3ca8bf0bf700.png)

- インスタンスを生成します。データベースエンジンは今回 MySQL を選択します。

![image.png](/images/c7b1bd4feb8800/5eac32d1-087a-9a78-249b-c9689c623aa5.png)

![image.png](/images/c7b1bd4feb8800/2dbe833d-8213-f526-e813-ffef6e49be3a.png)

- インスタンス ID とパスワードを設定します。インスタンス ID は分かりやすいものであれば何でも OK です。パスワードはこのデータベースに root ユーザーでアクセスするものになるので控えておきましょう。右にある`生成`を押すと安全なパスワードを生成できます。今回 MySQL のバージョンは`8.0`を選択しました。

![image.png](/images/c7b1bd4feb8800/e6ab2f39-dd06-2205-f0c4-a245bae9f9ad.png)

- 構成の選択を行います。本番環境用のマッチョな構成か、開発環境用のコスパ高い構成かを選べます。今回は開発用なので`development`を選択しました。画面にも説明がありますが、構成の選択と言ってもオススメの設定をとりあえず GCP が設定してくれるだけで、後ほど各項目をカスタマイズできます。なのであんまり深く考えるところではないですね。

![image.png](/images/c7b1bd4feb8800/06d5b163-02c7-3007-e58c-8ec7a44dcfeb.png)

- リージョンとゾーンを選択します。今回は東京にしました。開発用なので高可用性にするかどうかはノーで大丈夫です。詳しく知りたい方は以下ドキュメントを参考にしてください。

![image.png](/images/c7b1bd4feb8800/38bed488-fd5e-183b-d90e-52bf4feddae4.png)

https://cloud.google.com/solutions/cloud-sql-mysql-disaster-recovery-complete-failover-fallback?hl=ja

- マシンタイプを選択します。共有コアが一番安くなりますが、メモリが 1GB 切ってるのが何か嫌なので`軽量`を選択しました。

![image.png](/images/c7b1bd4feb8800/e4672558-f1bf-4e50-af39-31d617a41ccf.png)

- ストレージの設定を行います。`SSD`、`10GB`、自動増量はオフにしました。`暗号化`のところはあんまり分かってません・・・。

![image.png](/images/c7b1bd4feb8800/cd7f47ce-8a03-40dd-3170-64ad4167065a.png)

- 接続の設定を行います。今回何も設定してませんが、GAE インスタンスからはアクセスできたので、よしなにやってくれてるんだろうか・・・？

![image.png](/images/c7b1bd4feb8800/42f04a41-abb3-be40-fad7-bf5ef53c97a0.png)

- データの保護の箇所です。実験用なので全てオフにします。

![image.png](/images/c7b1bd4feb8800/bb20f203-0969-11e2-36f8-2cb3fb88c508.png)

- メンテナンスの設定です。本番環境だと、例えば日中によく使われるシステム(例えば営業ツールとか)だからメンテナンスは夜に実行されるように、みたいな調整をするようです。

![image.png](/images/c7b1bd4feb8800/163cb35f-2e57-219f-cb31-34df5e8ae8d3.png)

- フラグとラベルは設定不要です。インスタンスを生成をクリックしてください。5 分程度時間かかりますが、インスタンス生成完了まで待ちましょう。完了したらインスタンス名をクリックします。

![image.png](/images/c7b1bd4feb8800/c98bed21-fe86-f9b4-8dc4-883f467cb1b7.png)

- 接続名も後ほど使いますので控えておいてください。終わったら`CLOUD SHELLで開く`を押下してください。

![image.png](/images/c7b1bd4feb8800/4b9c3a54-6578-b903-ed20-094222bea869.png)

# Docker ファイルを準備する

Dockerfile に接続うんぬんは GAE 側がやってくれるっぽい。
ポートの開放とかはやっていない。

# CloudSQLとGoアプリケーションを接続する

# app.yaml を準備する

# デプロイしてみましょう

確認するべきはアカウントとプロジェクト
スクリプトにまとめてあるけど、大事なのは gcloud app deploy ですよ。

# おまけの話、ローカルで起動する場合

env ファイルの取り扱いが難しいというかめんどくさい。
どうしよっかなーという感じ。

# おまけその２

GAE のフレキシブル環境かつ Docker の記事が少ないのって何でだろうと考えてみたところ、それなら CloudRun 使うわっていう話なのかもと思いました。
